name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl python-docx
    
    - name: Validate Python scripts
      run: |
        python -m py_compile create_pmo_system.py
        python -m py_compile create_word_templates.py
        python -m py_compile create_zip.py
    
    - name: Check HTML files
      run: |
        echo "Validating HTML structure..."
        # Add HTML validation if needed
    
    - name: Check JavaScript syntax
      run: |
        echo "JavaScript files present:"
        find frontend/js -name "*.js" -type f

  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl python-docx
    
    - name: Generate Excel file
      run: python create_pmo_system.py
    
    - name: Generate Word templates
      run: python create_word_templates.py
    
    - name: Create ZIP archive
      run: python create_zip.py
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          *.xlsx
          *.zip
          Templates/*.docx
        retention-days: 7

  deploy-netlify:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js (for Netlify CLI)
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Netlify CLI
      run: npm install -g netlify-cli
    
    - name: Deploy to Netlify
      uses: netlify/actions/cli@master
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      with:
        args: deploy --dir=. --prod=${{ github.ref == 'refs/heads/main' }}
        secrets: ${{ toJSON(secrets) }}

  deploy-nas-staging:
    name: Deploy to NAS (Staging)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl python-docx
    
    - name: Generate Excel file
      run: python create_pmo_system.py
    
    - name: Generate Word templates
      run: python create_word_templates.py
    
    - name: Create ZIP archive
      run: python create_zip.py
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.NAS_SSH_PRIVATE_KEY }}
    
    - name: Add NAS to known hosts
      run: |
        ssh-keyscan -p 2222 -H 192.168.1.3 >> ~/.ssh/known_hosts
    
    - name: Create deployment directory
      run: |
        ssh -p 2222 ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} << 'EOF'
          mkdir -p ${{ secrets.NAS_PATH }}/staging
          mkdir -p ${{ secrets.NAS_PATH }}/staging/frontend/{css,js,assets}
          mkdir -p ${{ secrets.NAS_PATH }}/staging/Templates
        EOF
    
    - name: Deploy files to NAS (Staging)
      run: |
        rsync -avz --delete -e "ssh -p 2222" \
          frontend/ \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/staging/frontend/
        rsync -avz -e "ssh -p 2222" \
          landing.html download.html \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/staging/
        rsync -avz -e "ssh -p 2222" \
          Templates/ \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/staging/Templates/
        rsync -avz -e "ssh -p 2222" \
          *.xlsx *.zip \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/staging/ 2>/dev/null || true
    
    - name: Set permissions on NAS
      run: |
        ssh -p 2222 ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} \
          "chmod -R 755 ${{ secrets.NAS_PATH }}/staging && chown -R ${{ secrets.NAS_USER }}:users ${{ secrets.NAS_PATH }}/staging 2>/dev/null || true"
    
    - name: Deployment Summary
      run: |
        echo "✅ Deployment to NAS Staging complete!"
        echo "Environment: staging"
        echo "NAS Path: ${{ secrets.NAS_PATH }}/staging"
        echo "Access URL: http://${{ secrets.NAS_HOST }}/aiscr-pmo/staging/"

  deploy-nas-production:
    name: Deploy to NAS (Production)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      # REQUIRES MANUAL APPROVAL - Production deployments must be validated first
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl python-docx
    
    - name: Generate Excel file
      run: python create_pmo_system.py
    
    - name: Generate Word templates
      run: python create_word_templates.py
    
    - name: Create ZIP archive
      run: python create_zip.py
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.NAS_SSH_PRIVATE_KEY }}
    
    - name: Add NAS to known hosts
      run: |
        ssh-keyscan -p 2222 -H 192.168.1.3 >> ~/.ssh/known_hosts
    
    - name: Create deployment directory
      run: |
        ssh -p 2222 ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} << 'EOF'
          mkdir -p ${{ secrets.NAS_PATH }}/production
          mkdir -p ${{ secrets.NAS_PATH }}/production/frontend/{css,js,assets}
          mkdir -p ${{ secrets.NAS_PATH }}/production/Templates
        EOF
    
    - name: Deploy files to NAS (Production)
      run: |
        rsync -avz --delete -e "ssh -p 2222" \
          frontend/ \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/production/frontend/
        rsync -avz -e "ssh -p 2222" \
          landing.html download.html \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/production/
        rsync -avz -e "ssh -p 2222" \
          Templates/ \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/production/Templates/
        rsync -avz -e "ssh -p 2222" \
          *.xlsx *.zip \
          ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/production/ 2>/dev/null || true
    
    - name: Set permissions on NAS
      run: |
        ssh -p 2222 ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} \
          "chmod -R 755 ${{ secrets.NAS_PATH }}/production && chown -R ${{ secrets.NAS_USER }}:users ${{ secrets.NAS_PATH }}/production 2>/dev/null || true"
    
    - name: Deployment Summary
      run: |
        echo "✅ Deployment to NAS Production complete!"
        echo "Environment: production"
        echo "NAS Path: ${{ secrets.NAS_PATH }}/production"
        echo "Access URL: http://${{ secrets.NAS_HOST }}/aiscr-pmo/production/"

