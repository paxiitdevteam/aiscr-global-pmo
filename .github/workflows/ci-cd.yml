name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl python-docx
    
    - name: Validate Python scripts
      run: |
        python -m py_compile create_pmo_system.py
        python -m py_compile create_word_templates.py
        python -m py_compile create_zip.py
    
    - name: Check HTML files
      run: |
        echo "Validating HTML structure..."
        # Add HTML validation if needed
    
    - name: Check JavaScript syntax
      run: |
        echo "JavaScript files present:"
        find frontend/js -name "*.js" -type f

  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openpyxl python-docx
    
    - name: Generate Excel file
      run: python create_pmo_system.py
    
    - name: Generate Word templates
      run: python create_word_templates.py
    
    - name: Create ZIP archive
      run: python create_zip.py
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          *.xlsx
          *.zip
          Templates/*.docx
        retention-days: 7

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js (for Netlify CLI)
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Netlify CLI
      run: npm install -g netlify-cli
    
    - name: Deploy to Netlify
      uses: netlify/actions/cli@master
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      with:
        args: deploy --dir=. --prod=${{ github.ref == 'refs/heads/main' }}
        secrets: ${{ toJSON(secrets) }}

