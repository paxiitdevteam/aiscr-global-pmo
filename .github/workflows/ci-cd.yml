# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
#
# ‚ö†Ô∏è IMPORTANT: VS Code may show warnings about "Context access might be invalid" for secrets.
# These are FALSE POSITIVES - the syntax ${{ secrets.* }} is 100% CORRECT for GitHub Actions.
# The workflow will work perfectly when secrets are configured in GitHub repository settings.
# You can safely ignore these warnings - they do NOT affect functionality.
#
# Required Secrets (configure in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions):
# - NAS_SSH_PRIVATE_KEY: SSH private key for NAS access
# - NAS_USER: NAS username
# - NAS_HOST: NAS hostname or IP
# - NAS_PATH: Deployment path on NAS
# - NETLIFY_AUTH_TOKEN: Netlify authentication token (if using Netlify)
# - NETLIFY_SITE_ID: Netlify site ID (if using Netlify)
#
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate Python scripts
      run: |
        echo "Validating Python scripts..."
        if [ -f create_pmo_system.py ]; then
          python -m py_compile create_pmo_system.py || exit 1
        else
          echo "‚ö†Ô∏è Warning: create_pmo_system.py not found"
        fi
        if [ -f create_word_templates.py ]; then
          python -m py_compile create_word_templates.py || exit 1
        else
          echo "‚ö†Ô∏è Warning: create_word_templates.py not found"
        fi
        if [ -f create_zip.py ]; then
          python -m py_compile create_zip.py || exit 1
        else
          echo "‚ö†Ô∏è Warning: create_zip.py not found"
        fi
        echo "‚úÖ Python validation complete"
    
    - name: Check HTML files
      run: |
        echo "Validating HTML structure..."
        if [ -f index.html ]; then
          echo "‚úÖ index.html found"
        fi
        if [ -f home.html ]; then
          echo "‚úÖ home.html found"
        fi
    
    - name: Check JavaScript syntax
      run: |
        echo "Checking JavaScript files..."
        if [ -d frontend/js ]; then
          JS_COUNT=$(find frontend/js -name "*.js" -type f 2>/dev/null | wc -l)
          if [ "$JS_COUNT" -gt 0 ]; then
            echo "‚úÖ Found $JS_COUNT JavaScript files"
            find frontend/js -name "*.js" -type f | head -5
          else
            echo "‚ö†Ô∏è No JavaScript files found in frontend/js"
          fi
        else
          echo "‚ö†Ô∏è frontend/js directory not found (this is OK if not using frontend)"
        fi

  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate Excel file
      run: |
        if [ -f create_pmo_system.py ]; then
          python create_pmo_system.py || { echo "‚ùå Failed to generate Excel file"; exit 1; }
          echo "‚úÖ Excel file generated successfully"
        else
          echo "‚ö†Ô∏è create_pmo_system.py not found, skipping Excel generation"
        fi
    
    - name: Generate Word templates
      run: |
        if [ -f create_word_templates.py ]; then
          python create_word_templates.py || { echo "‚ùå Failed to generate Word templates"; exit 1; }
          echo "‚úÖ Word templates generated successfully"
        else
          echo "‚ö†Ô∏è create_word_templates.py not found, skipping Word template generation"
        fi
    
    - name: Create ZIP archive
      run: |
        if [ -f create_zip.py ]; then
          python create_zip.py || { echo "‚ùå Failed to create ZIP archive"; exit 1; }
          echo "‚úÖ ZIP archive created successfully"
        else
          echo "‚ö†Ô∏è create_zip.py not found, skipping ZIP creation"
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          *.xlsx
          *.zip
          Templates/*.docx
        retention-days: 7
        if-no-files-found: warn

  deploy-nas-staging:
    name: Deploy to NAS (Staging/Testing)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate Excel file
      run: |
        if [ -f create_pmo_system.py ]; then
          python create_pmo_system.py || { echo "‚ùå Failed to generate Excel file"; exit 1; }
        else
          echo "‚ö†Ô∏è create_pmo_system.py not found, skipping"
        fi
    
    - name: Generate Word templates
      run: |
        if [ -f create_word_templates.py ]; then
          python create_word_templates.py || { echo "‚ùå Failed to generate Word templates"; exit 1; }
        else
          echo "‚ö†Ô∏è create_word_templates.py not found, skipping"
        fi
    
    - name: Create ZIP archive
      run: |
        if [ -f create_zip.py ]; then
          python create_zip.py || { echo "‚ùå Failed to create ZIP archive"; exit 1; }
        else
          echo "‚ö†Ô∏è create_zip.py not found, skipping"
        fi
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.NAS_SSH_PRIVATE_KEY }}
      continue-on-error: true
    
    - name: Add NAS to known hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -p 2222 -H ${{ secrets.NAS_HOST || '192.168.1.3' }} >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 600 ~/.ssh/known_hosts
    
    - name: Verify SSH secrets
      run: |
        if [ -z "${{ secrets.NAS_USER }}" ] || [ -z "${{ secrets.NAS_HOST }}" ] || [ -z "${{ secrets.NAS_PATH }}" ]; then
          echo "‚ùå Missing required SSH secrets (NAS_USER, NAS_HOST, NAS_PATH)"
          echo "‚ö†Ô∏è Skipping NAS deployment - configure secrets in GitHub repository settings"
          exit 0
        fi
        echo "‚úÖ SSH secrets configured"
    
    - name: Create deployment directory
      if: secrets.NAS_USER != '' && secrets.NAS_HOST != '' && secrets.NAS_PATH != ''
      run: |
        ssh -p 2222 -o StrictHostKeyChecking=no ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} << 'EOF' || true
          mkdir -p ${{ secrets.NAS_PATH }}
          mkdir -p ${{ secrets.NAS_PATH }}/frontend/{css,js,assets}
          mkdir -p ${{ secrets.NAS_PATH }}/Templates
          mkdir -p ${{ secrets.NAS_PATH }}/backups
        EOF
    
    - name: Deploy files to NAS
      if: secrets.NAS_USER != '' && secrets.NAS_HOST != '' && secrets.NAS_PATH != ''
      run: |
        echo "üöÄ Starting deployment to NAS..."
        if [ -d frontend ]; then
          rsync -avz --delete -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            frontend/ \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/frontend/ || echo "‚ö†Ô∏è Frontend deployment failed"
        fi
        if [ -f home.html ] || [ -f download-center.html ]; then
          rsync -avz -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            home.html download-center.html \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/ 2>/dev/null || echo "‚ö†Ô∏è HTML files deployment failed"
        fi
        if [ -d Templates ]; then
          rsync -avz -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            Templates/ \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/Templates/ || echo "‚ö†Ô∏è Templates deployment failed"
        fi
        if ls *.xlsx *.zip 2>/dev/null; then
          rsync -avz -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            *.xlsx *.zip \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/ 2>/dev/null || echo "‚ö†Ô∏è Archive files deployment failed"
        fi
        echo "‚úÖ Deployment completed"
    
    - name: Set permissions on NAS
      if: secrets.NAS_USER != '' && secrets.NAS_HOST != '' && secrets.NAS_PATH != ''
      run: |
        ssh -p 2222 -o StrictHostKeyChecking=no ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} \
          "chmod -R 755 ${{ secrets.NAS_PATH }} && chown -R ${{ secrets.NAS_USER }}:users ${{ secrets.NAS_PATH }} 2>/dev/null || true" || echo "‚ö†Ô∏è Permission setting failed"
    
    - name: Deployment Summary
      run: |
        if [ -z "${{ secrets.NAS_USER }}" ] || [ -z "${{ secrets.NAS_HOST }}" ] || [ -z "${{ secrets.NAS_PATH }}" ]; then
          echo "‚ö†Ô∏è NAS deployment skipped - secrets not configured"
          echo "üí° Configure NAS_SSH_PRIVATE_KEY, NAS_USER, NAS_HOST, NAS_PATH in repository settings"
        else
          echo "‚úÖ Deployment to NAS complete!"
          echo "NAS Path: ${{ secrets.NAS_PATH }}"
          echo "Access URL: http://${{ secrets.NAS_HOST }}/pmo/"
        fi

  deploy-nas-production:
    name: Deploy to NAS (Production)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      # REQUIRES MANUAL APPROVAL - Production deployments must be validated first
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate Excel file
      run: |
        if [ -f create_pmo_system.py ]; then
          python create_pmo_system.py || { echo "‚ùå Failed to generate Excel file"; exit 1; }
        else
          echo "‚ö†Ô∏è create_pmo_system.py not found, skipping"
        fi
    
    - name: Generate Word templates
      run: |
        if [ -f create_word_templates.py ]; then
          python create_word_templates.py || { echo "‚ùå Failed to generate Word templates"; exit 1; }
        else
          echo "‚ö†Ô∏è create_word_templates.py not found, skipping"
        fi
    
    - name: Create ZIP archive
      run: |
        if [ -f create_zip.py ]; then
          python create_zip.py || { echo "‚ùå Failed to create ZIP archive"; exit 1; }
        else
          echo "‚ö†Ô∏è create_zip.py not found, skipping"
        fi
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.NAS_SSH_PRIVATE_KEY }}
      continue-on-error: true
    
    - name: Add NAS to known hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -p 2222 -H ${{ secrets.NAS_HOST || '192.168.1.3' }} >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 600 ~/.ssh/known_hosts
    
    - name: Verify SSH secrets
      run: |
        if [ -z "${{ secrets.NAS_USER }}" ] || [ -z "${{ secrets.NAS_HOST }}" ] || [ -z "${{ secrets.NAS_PATH }}" ]; then
          echo "‚ùå Missing required SSH secrets (NAS_USER, NAS_HOST, NAS_PATH)"
          echo "‚ö†Ô∏è Skipping NAS deployment - configure secrets in GitHub repository settings"
          exit 0
        fi
        echo "‚úÖ SSH secrets configured"
    
    - name: Create deployment directory
      if: secrets.NAS_USER != '' && secrets.NAS_HOST != '' && secrets.NAS_PATH != ''
      run: |
        ssh -p 2222 -o StrictHostKeyChecking=no ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} << 'EOF' || true
          mkdir -p ${{ secrets.NAS_PATH }}
          mkdir -p ${{ secrets.NAS_PATH }}/frontend/{css,js,assets}
          mkdir -p ${{ secrets.NAS_PATH }}/Templates
          mkdir -p ${{ secrets.NAS_PATH }}/backups
        EOF
    
    - name: Deploy files to NAS (Production)
      if: secrets.NAS_USER != '' && secrets.NAS_HOST != '' && secrets.NAS_PATH != ''
      run: |
        echo "üöÄ Starting production deployment to NAS..."
        if [ -d frontend ]; then
          rsync -avz --delete -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            frontend/ \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/frontend/ || echo "‚ö†Ô∏è Frontend deployment failed"
        fi
        if [ -f home.html ] || [ -f download-center.html ]; then
          rsync -avz -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            home.html download-center.html \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/ 2>/dev/null || echo "‚ö†Ô∏è HTML files deployment failed"
        fi
        if [ -d Templates ]; then
          rsync -avz -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            Templates/ \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/Templates/ || echo "‚ö†Ô∏è Templates deployment failed"
        fi
        if ls *.xlsx *.zip 2>/dev/null; then
          rsync -avz -e "ssh -p 2222 -o StrictHostKeyChecking=no" \
            *.xlsx *.zip \
            ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }}:${{ secrets.NAS_PATH }}/ 2>/dev/null || echo "‚ö†Ô∏è Archive files deployment failed"
        fi
        echo "‚úÖ Production deployment completed"
    
    - name: Set permissions on NAS
      if: secrets.NAS_USER != '' && secrets.NAS_HOST != '' && secrets.NAS_PATH != ''
      run: |
        ssh -p 2222 -o StrictHostKeyChecking=no ${{ secrets.NAS_USER }}@${{ secrets.NAS_HOST }} \
          "chmod -R 755 ${{ secrets.NAS_PATH }} && chown -R ${{ secrets.NAS_USER }}:users ${{ secrets.NAS_PATH }} 2>/dev/null || true" || echo "‚ö†Ô∏è Permission setting failed"
    
    - name: Deployment Summary
      run: |
        if [ -z "${{ secrets.NAS_USER }}" ] || [ -z "${{ secrets.NAS_HOST }}" ] || [ -z "${{ secrets.NAS_PATH }}" ]; then
          echo "‚ö†Ô∏è NAS deployment skipped - secrets not configured"
          echo "üí° Configure NAS_SSH_PRIVATE_KEY, NAS_USER, NAS_HOST, NAS_PATH in repository settings"
        else
          echo "‚úÖ Deployment to NAS Production complete!"
          echo "NAS Path: ${{ secrets.NAS_PATH }}"
          echo "Access URL: http://${{ secrets.NAS_HOST }}/pmo/"
        fi

